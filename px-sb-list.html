<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs
-->
<link rel="import" href="bower_components/polymer/polymer.html" />
<link rel="import" href="bower_components/iron-collapse/iron-collapse.html" />
<!--
Element providing a dropdown solution.

##### Usage

```
<px-sb display-value="Text">
  <px-sb-content class="px-sb-content" extend-dropdown="true" extend-dropdown-by="25" max-cont-character-width="10" items='[{"key":"one", "val": "One"}, {"key":"two", "val": "Two"}, {"key":"three", "val": "Three"}, {"key":"four", "val": "How now brown cow"}]'>
  </px-sb-content>
</px-sb>
```

@element px-sb
@blurb Element providing a dropdown solution.
@homepage index.html
@demo demo.html
-->
<link rel="import" href="css/px-sb-list-styles.html">

<dom-module id="px-sb-list">
  <template>
    <style include="px-sb-list-styles"></style>
    <style include="px-theme-styles"></style>
    <template is="dom-if" if="_showNavItem(navItem)">
      <li on-tap="_toggle" class="flex flex--middle nav-group-lnk">
        <div class="arrow-right arrow" data-name$="{{_removeSpaces(navItem)}}"></div>
        <div class="u-ml--" data-name$="{{_removeSpaces(navItem)}}">{{navItem.linkText}}</div>
      </li>
      <iron-collapse id$="collapse_{{_removeSpaces(navItem)}}">
        <ul>
          <template is="dom-repeat" items="{{navItem.links}}">
            <template is="dom-if" if="{{_hasKids(item)}}">
              <px-sb-list nav-item="{{item}}"></px-sb-list>
            </template>
            <template is="dom-if" if="{{_isItemVisible(item)}}">
              <li><a class="nav-lnk" data-type$="{{item.dataType}}" data-name$="{{item.repoName}}" on-click="_itemClick">{{item.linkText}}</a></li>
            </template>
          </template>
    </template>
    <template is="dom-if" if="_showNavItem(item)">
        </ul>
      </iron-collapse>
    </template>
    <!-- close the iron collapse list, if it was opened -->

  </template>
</dom-module>
<script>
  Polymer({
    is: 'px-sb-list',
    properties: {
      navItem: {
        type: Object,
        value: function() {return {};},
        notify: true
      },
      searchKeyword: {
        type: String,
        value: ''
      },
      show : {
        type: String,
        value: ''
      },
      type: {
        type: String,
        value: ''
      },
      types: {
        type: Object,
        value: {
          "component" : function(name) {
            return "https://predixdev.github.io/" + name + "/" + name + "/";
          },
          "local": function(name) {
            return name + ".html";
          },
          "external" : function(name) {
            return "https://github.com/predixdev/" + name;
          }
        }
      }
    },
    attached: function() {
      this._getRoute();
    },
    _getURLParameter: function(sParam) {
      var sPageURL = window.location.search.substring(1),
          sURLVariables = sPageURL.split('&'),
          i,
          len = sURLVariables.length,
          sParameterName;

      for (i = 0; i < len; i++) {
        sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] === sParam) {
          return sParameterName[1];
        }
      }
    },
    _itemClick: function(evt) {
      var target = evt.target,
          repoName = target.getAttribute('data-name'),
          type = target.getAttribute('data-type'),
          otherLinks = Polymer.dom(this.root).querySelectorAll(".selected");

          if (type !== "external") {
            otherLinks.forEach(function(otherLink) {
              otherLink.classList.remove("selected");
            });

            target.classList.add("selected");
          }

          this._setRoute(repoName, type);
    },
    _getWantedFrame: function(name, type) {
      if  (type === "external") {
        window.open(this.types.external(name), '_blank');
        return false;
      } else if (name && type) {
        return this.types[type](name);
      }
      else {
        return 'landing_page.html';
      }
    },
    _setRoute: function(name, type) {
      window.history.pushState('','','?show=' + name + '&type=' + type);
      this._changeIframeUrl(name, type);
    },
    _getRoute: function() {
      this.name = this._getURLParameter('show') || null;
      this.type = this._getURLParameter('type') || null;
      this._changeIframeUrl(this.name, this.type);
    },
    _changeIframeUrl: function(name, type) {
      var iframeUrl = this._getWantedFrame(name, type);
      if (iframeUrl) {
        this.fire('iframeUrlChange', {url: iframeUrl});
      }
    },
    _removeSpaces: function(name) {
      return name.linkText.toLowerCase().replace(/ /g, "_");
    },
    _toggle: function(evt) {
      var parentElement = evt.target.parentElement,
          arrow = Polymer.dom(parentElement).querySelector('.arrow'),
          name = arrow.getAttribute('data-name'),
          //find out if the clicked item has arrow right or down
          arrowRight = arrow.classList.contains('arrow-right'),
          arrowDown = arrow.classList.contains('arrow-down'),
          flipArrowRight = !arrowRight,
          flipArrowDown = !arrowDown;

      name = name.toLowerCase().replace(/ /g, "_");
      this.$$('#collapse_' + name).toggle();

      // and if they do have one of those, set the existing one to false, and missing one to true.
      this.toggleClass('arrow-right', flipArrowRight, arrow);
      this.toggleClass('arrow-down', flipArrowDown, arrow);
    },
    _showNavItem: function(navArr) {
      var len = navArr.length,
          i,
          query = this.searchKeyword;

      //if there's no query, always return true;
      if (!query) {
        return true;
      }

      //else, loop through the sub-items recursively
      for (i = 0; i < len; i++) {
        if (navArr[i].links) {
          this._showNavItem(navArr[i]);
        }
        //check if this item has the search query in the text. Since we made sure that query isn't false, we'd never reach this stage without query being true.
        if (this._searchMatch(navArr[i])) {
          return true;
        }
      }
      //if we've reached this point, none of the subitems contain the search query, and we'd like to hide this item.
      return false;
    },
    _isItemVisible: function(item) {
      return this._hasNoKids(item) && this._searchMatch();
    },
    _hasNoKids: function(item) {
      //if there are no links, it has no kids.
      return !item.links;
    },
    _hasKids: function(item) {
      return item.links;
    },
    _searchMatch: function(item) {
      var query = this.searchKeyword;
      //search the text of the link text for the query
      return (query) ? item.linkText.indexOf(query) > -1 : true;
    }
  });
</script>
