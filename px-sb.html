<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs
-->
<link rel="import" href="bower_components/polymer/polymer.html" />
<link rel="import" href="px-sb-list.html" />
<link rel="import" href="bower_components/px-polymer-font-awesome/polymer-font-awesome.html" />
<!--
Element providing sidebar for the predix ui website.

##### Usage

```

```

@element px-sb
@blurb Element providing sidebar for the predix ui website.
@homepage index.html
@demo demo.html
-->
<link rel="import" href="css/px-sb-styles.html">

<dom-module id="px-sb">
  <template>
    <style include="px-sb-styles"></style>
    <style include="px-theme-styles"></style>
    <div class="search">
      <div class="input">
        <input id="searchInput" type="text" value="{{searchKeyword::input}}" placeholder="Type In A Search Term...">
      </div>
      <div class="icon"><iron-icon icon="fa:fa-times" class="fa-x" on-click="_resetSearch" id="searchIcon"></iron-icon></div>
    </div>
    <ul style="margin-top:40px;">
      <template is="dom-repeat" items="{{nav}}">
        <px-sb-list nav-item="[[item]]" selected="{{selected}}" search-keyword="{{searchKeyword}}" item-path="[[index]].links" selected-elem="{{selectedElem}}"></px-sb-list>
      </template>
    </ul>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'px-sb',
    attached: function() {
      //we call this to find out if there a component is specified in the url
      this.getRoute();
      //and configure a listener that listens to popstate - which is activated by the back and forward buttons.
      // we listen to these to make sure the left nav is in sync with the url, and with the content window.
      window.addEventListener('popstate', this._popStateChanged.bind(this));
    },
    /*
    * Called when the X is pressed in the search bar, this method resets the searchKeyword property and
    * resets the selected property, in case there was a selection while the nav was filtered through search.
    *
    * @method _resetSearch
     */
    _resetSearch: function() {
      this.set('searchKeyword','');
      this.$.searchInput.focus();

      //this is async'd to give the nav time to rebuild
      this.async(function() {

        var name = this.selectedElem.getAttribute('data-name'),
            type = this.selectedElem.getAttribute('data-type'),
            newSelectedPath = this._findItemPath(this.nav, name),
            oldPath = this._findItemPath(this.nav, this.previousSelectedName),
            obj = {};

            obj.detail = {};
            obj.detail.selectedItem = name;
            obj.detail.itemType = type;

        // we send a newValue and an oldValue to _selectedChange first, TO "zero out" the oldVal portion of _selectedChange
        this._selectedChange('nav.' + newSelectedPath, 'nav.' + oldPath);

        this._launchSelectedChange(obj);
        //and we have to changed the selected attribute as well - please note that this will trigger a call to _selectedChange, but the oldVal in that will be set correctly because of the line above.
        //this.set('selected', 'nav.' + newSelectedPath);

        //and reset everything so it's ready for next time.
        this.set('selectedElem',{});
        this.set('previousSelectedName', '');

      },50);
    },
    /*
    *
    * recuresively search the model for the item passed, and
    * returns an array that represents the path to the item,
    *
    * Also sets the selected property to the path found, in string notation - for example, 0.links.3.links.3
    *
    * @method _findItemTrail
    * @prop navArr {Object}
    * @prop selectedItemEvt {object}
    * @prop path {String}
     */
    _findItemTrail: function(navArr, selectedItem, path) {
      var i,
          len,
          oldPath,
          arr;

      for (i = 0, len = navArr.length; i < len; i++) {
        if (navArr[i].links) {
          oldPath = path;
          path = (path)?path:'';
          path += i.toString() + '.links.';

          //this will return null when it can't find anything, but if it does find something, we grab the array its returned, push that into another array, and return that.
          arr = this._findItemTrail(navArr[i].links, selectedItem, path);
          if (arr !== null) {
            navArr[i].path = path.substr(0,path.length - 7);
            arr.push(navArr[i]);
            //this is the final return, after the recursion is done
            return arr;
          } else {
            //we found nothing, we don't need this path. reset.
            path = oldPath;
          }
        }

        if (navArr[i].repoName === selectedItem) {
          path += i.toString();
          //this.set('nav.' + path +'.selected',true);
          this.set('selected', 'nav.' + path);
          navArr[i].path = path;
          //this will return into the recursion.
          return [navArr[i]];
        }
      }
      //this will only hit if we didn't find anything in the recursive search.
      return null;
    },
    /*
    *
    * recuresively search the model for the item passed, and
    * returns an path that represents the path to the item in string notation - for example, 0.links.3.links.3
    *
    * @method _findItemPath
    * @prop navArr {Object}
    * @prop selectedItem {String}
    * @prop path {String}
     */
    _findItemPath: function(navArr, selectedItem, path) {
      var i,
          len,
          foundPath;

      for (i = 0, len = navArr.length; i < len; i++) {
        if (navArr[i].links) {
          var oldPath = path;
          path = (path)?path:'';
          path += i.toString() + '.links.';

          foundPath = this._findItemPath(navArr[i].links, selectedItem, path);
          if (foundPath === null) {
            //we found nothing, we don't need this path. reset.
            path = oldPath;
          } else {
            //this is the final return
            return foundPath;
          }
        }

        if (navArr[i].repoName === selectedItem) {
          //this will return into the recursion.
          return path + i.toString();
        }
      }
      //this will only hit if we didn't find anything in the recursive search.
      return null;
    },
    /*
    *
    * loops through the trail (array) given to it, and sets the opened property on each item
    * @method _changeOpenedProperty
     */
    _changeOpenedProperty: function(trail) {
      if (typeof trail === 'string') {
        this.set('nav.' + trail + '.opened', true);
      } else {
        if (trail && trail.length) {
          trail.forEach(function(item) {
            this.set('nav.' + item.path + '.opened', true);
          }.bind(this));
        }
      }
    },
    /*
    *
    * sets the selected property to the path specified in the event.
    * @method _setSelected
     */
    _setSelected: function(evt) {
      if (evt.detail.path) {
        this.set('selected', 'nav.'+ evt.detail.path);
      }
    },
    /*
    *
    * Called when the "px-sb-list-selected-item-changed" event is fired, This method sets the name and type properties of the selected item on px-sb,
    * sets the route (changes iframe url and window.history), removes all the opened=true properties on the arrows, finds the trail from the selected item up to the root,
    * and sets opened=true on the correct arrows, and last but not least, sets the item as the selected item.
    * @method _launchSelectedChange
     */
    _launchSelectedChange: function(selectedItem) {
      var item = selectedItem.detail;
      this.set('name', item.selectedItem);
      this.set('type', item.itemType);
      //load the correct url into the iframe, and set the window.history change.
      this._setRoute(item.selectedItem, item.itemType, item.path);
      //the trail is path from the top menu to the selected item - needed so we can set opened=true on the arrow that are part of the path.
      //and make sure to change our selected property.
      this._setSelected(selectedItem);
    },

    listeners: {
      'px-sb-list-selected-item-changed' : '_launchSelectedChange'
    },
    /*
    *
    * Pop state is called on a click on the back or forward button on the browser.
    * Since we are changing the window.history object, this method ensures that when those buttons are clicked, the behaviour is as expected.
    * @method _popStateChanged
    * @prop e {Event}
     */
    _popStateChanged: function(e) {
      //set up the object with the correct info and property that _launchSelectedChange expectes, emulating the event structure.
      var obj = {};
      obj.detail = {};
      obj.detail.selectedItem = e.state.name;
      obj.detail.itemType = e.state.type;
      obj.detail.path = e.state.path;
      this._launchSelectedChange(obj);
      // we don't want the back or forward button to actually do their intended action.
      e.preventDefault();
    },
    /*
    *
    * Called when the search Keyword is changed to call the filter on the nav.
    * To ensure we don't do this on every single key down, we have a debounce in place.
    * @method _computedNav
    * @prop navArr {Object}
    * @prop searchKeyword {String}
     */
    _computedNav: function(navArr, searchKeyword) {
      //if there's no searchKeyword, nothing needs to be rebuild. return the existing nav.
      if (searchKeyword === '') {
        this.set('nav', this.initialNav);
        return;
      }

      this.debounce('navBuild', function() {
        //if the user has an item selected, types in a search, and then clicks on an item in the filtered list, and THEN hits the X, we need to know the
        //name of the item that was selected before the search, so we can remove the selected property on it. we can't remove it automatically, since another scenario is for
        //the user to have a selected item, search, NOT select anything, and click X, in which point we want the previously selected one to still be selected.
        this.set('previousSelectedName', this.name);
        //call the filter with the search keyword
        this.set('nav', this._buildNav(navArr, searchKeyword));
      }, 150);
    },
    /*
    *
    * Called when a search keyword is entered, and builds (and returns) a new nav Object that only contains the search query.
    * @_buildNav
    * @prop navArr {Object}
    * @prop searchKeyword {String}
     */
    _buildNav: function(navArr, searchKeyword) {
      var foundItems = [];
      for (var i = 0, len=navArr.length; i < len; i++) {
        //build our initial object and populate it.
        var currentObj = {};
        currentObj.linkText = navArr[i].linkText;
        currentObj.dataType = navArr[i].dataType;
        currentObj.repoName = navArr[i].repoName;
        currentObj.selected = navArr[i].selected;
        currentObj.opened = true;
        //if the item has links (ie children), recurse and if another array with links is returned, insert that into the object.
        if (navArr[i].links) {
          var tempArr = this._buildNav(navArr[i].links, searchKeyword);
          if (tempArr.length) {
            currentObj['links'] = tempArr;
          }
        }
        //lowercase both the search keyword, and link text, and compare - if there's a match, push it into the array.
        if (navArr[i].linkText.toLowerCase().indexOf(searchKeyword.toLowerCase()) !== -1 || currentObj.links) {
          foundItems.push(currentObj);
        }
      }
      //returns a rebuilt, filtered nav
      return foundItems;
    },
    /*
    *
    * called when the searchKeyword is changed, and sets off the nav rebuild process.
    * @method _callNavRebuild
     */
    _callNavRebuild: function() {
      if (this.searchKeyword) {
        this.set('nav', this.nav);
      }
    },
    /*
    * calculates the appropriate URL and returns it if it's local. if it's external, opens a new window, and returns false.
    * method _getWantedFrame
     */
    _getWantedFrame: function(name, type) {
      if  (type === "external") {
        window.open(this.types.external(name), '_blank');
        return false;
      } else if (name && type) {
        return this.types[type](name);
      }
    },
    /*
    * called on initial load, in case there is a component specified in the url.
    * changes the iframe url, and the window.history.state
     */
    _setRoute: function(name, type, path) {

      this._changeIframeUrl(name, type);

      window.history.pushState({name: name, type:type, path: path},'','?show=' + name + '&type=' + type);
    },
    getRoute: function() {
      var name = this._getURLParameter('show') || null,
          type = this._getURLParameter('type') || null;

      this.set('name', this._getURLParameter('show') || null);
      this.set('type', this._getURLParameter('type') || null);
      //TODO wrap this next one in an if statement, comparing the existing url to the new one, and only calling this on different URLs
      this._changeIframeUrl(this.name, this.type);

      if (this.name) {
        var trail = this._findItemTrail(this.nav, this.name),
        path;

        if (trail.length) {
          path = trail[0].path;
        }
    //using the trail, we set the opened=true properties on the correct arrows on initial load. the listener in sb-list does it on click from now on.
    this._changeOpenedProperty(trail);

    this.fire('px-sb-list-selected-item-changed', {selectedItem: this.name, itemType: this.type, path: path});

      }
    },
    _changeIframeUrl: function(name, type) {
      var iframeUrl = this._getWantedFrame(name, type),
          external = (type === 'external');
      this.fire('px-sb-list-iframe-url-change', {url: iframeUrl, external: external, name: name, type: type});
    },
    _getURLParameter: function(sParam) {
      var sPageURL = window.location.search.substring(1),
          sURLVariables = sPageURL.split('&'),
          i,
          len = sURLVariables.length,
          sParameterName;

      for (i = 0; i < len; i++) {
        sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] === sParam) {
          return sParameterName[1];
        }
      }
    },
    _selectedChange: function(newVal, oldVal) {
      var newPath = newVal  + '.selected',
          oldPath = oldVal  + '.selected';

      if (oldVal) {
        this.set(oldPath, false);
      }

      this.set(newPath, true);
    },
    observers: ['_computedNav(initialNav, searchKeyword)'],
    properties: {
      previousSelected:
      {
        type: String,
        value: ''
      },
      selectedElem: {
        type: Object,
        notify: true
      },
      types: {
        type: Object,
        value: {
          "component" : function(name) {
            return "https://predixdev.github.io/" + name + "/" + name + "/";
          },
          "local": function(name) {
            return name + ".html";
          },
          "external" : function(name) {
            return "https://github.com/predixdev/" + name;
          },
          "design": function(name) {
            return "https://predixdev.github.io/" + name + "/" + name + "/";
          },
          "home" : function() {
            return 'landing_page.html';
          }
        }
      },
      openedItemsArr: {
        type: Array,
        value: function() {return[];}
      },
      selected: {
        type: String,
        notify: true,
        observer: '_selectedChange'
      },
      opened: {
        type: Array,
        value: function(){return [];}
      },
      searchKeyword: {
        type: String,
        value: '',
        notify:true,
        observer: '_callNavRebuild'
      },
      nav: {
        type: Object,
        notify: true
      },
      initialNav: {
        type: Array,
        value: [{
            "linkText": "Home",
            "repoName": "landing_page",
            "dataType": "home",
          },
          {
            "linkText": "Getting Started",
            "links": [{
                "dataType": "local",
                "repoName": "getting_started",
                "linkText": "Using Predix UI Components"
            }, {
                "dataType": "external",
                "repoName": "px-getting-started",
                "linkText": "Predix UI CSS Overview"
            }, {
                "dataType": "external",
                "repoName": "generator-px-comp",
                "linkText": "Creating a New Component"
            }, {
                "dataType": "external",
                "repoName": "px-starter-kit-design",
                "linkText": "Bootstrapping Predix UI CSS"
            }],
            "opened": true
          },
          {
            "linkText": "Predix UI CSS",
            "links": [{
                "linkText": "Visual",
                "links": [{
                    "repoName": "px-actionable-text-icons-design",
                    "dataType": "external",
                    "linkText": "Actionable Text & Icons"
                    }, {
                    "linkText": "Buttons",
                      "links": [{
                          "repoName": "px-meta-buttons-design",
                          "dataType": "external",
                          "linkText": "Buttons (Meta)"
                          }, {
                          "repoName": "px-button-group-design",
                          "dataType": "external",
                          "linkText": "Button Group"
                          }, {
                          "repoName": "px-buttons-design",
                          "dataType": "external",
                          "linkText": "Buttons"
                          }]
                        }, {
                        "repoName": "px-code-design",
                        "dataType": "external",
                        "linkText": "Code"
                        }, {
                          "repoName": "px-colors-design",
                          "dataType": "external",
                          "linkText": "Colors"
                          }, {
                        "repoName": "px-forms-design",
                        "dataType": "external",
                        "linkText": "Forms"
                        }, {
                        "repoName": "px-headings-design",
                        "dataType": "external",
                        "linkText": "Headings"
                        }, {
                        "repoName": "px-helpers-design",
                        "dataType": "external",
                        "linkText": "Helpers"
                        }, {
                        "repoName": "px-input-group-design",
                        "dataType": "external",
                        "linkText": "Input Group"
                        }, {
                        "repoName": "px-layout-design",
                        "dataType": "external",
                        "linkText": "Layout"
                        }, {
                        "linkText": "Lists",
                          "links": [{
                          "repoName": "px-meta-lists-design",
                          "dataType": "external",
                          "linkText": "Lists (Meta)"
                          }, {
                          "repoName": "px-list-bare-design",
                          "dataType": "external",
                          "linkText": "List Bare"
                          }, {
                          "repoName": "px-list-inline-design",
                          "dataType": "external",
                          "linkText": "List Inline"
                          }, {
                          "repoName": "px-list-ui-design",
                          "dataType": "external",
                          "linkText": "List UI"
                          }]
                        }, {
                        "repoName": "px-tables-design",
                        "dataType": "external",
                        "linkText": "Tables"
                        }, {
                        "repoName": "px-toggle-design",
                        "dataType": "external",
                        "linkText": "Toggle"
                    }]
                  },
                  {
                "linkText": "Layout",
                  "links": [{
                    "repoName": "px-box-design",
                    "dataType": "external",
                    "linkText": "Box"
                    }, {
                    "repoName": "px-flag-design",
                    "dataType": "external",
                    "linkText": "Flag"
                    }, {
                    "repoName": "px-flexbox-design",
                    "dataType": "external",
                    "linkText": "Flexbox"
                    }, {
                    "repoName": "px-layout-design",
                    "dataType": "external",
                    "linkText": "Layout"
                    }, {
                    "repoName": "px-spacing-design",
                    "dataType": "external",
                    "linkText": "Spacing"
                    }, {
                    "repoName": "px-widths-design",
                    "dataType": "external",
                    "linkText": "Widths"
                    }, {
                    "repoName": "px-width-tools-design",
                    "dataType": "external",
                    "linkText": "Width Tools"
                    }]
                  },
                  {
                "linkText": "Utilities",
                  "links": [{
                    "repoName": "px-box-sizing-design",
                    "dataType": "external",
                    "linkText": "Box Sizing"
                    }, {
                    "repoName": "px-clearfix-design",
                    "dataType": "external",
                    "linkText": "Clearfix"
                    }, {
                    "repoName": "px-defaults-design",
                    "dataType": "external",
                    "linkText": "Defaults"
                    }, {
                    "repoName": "px-functions-design",
                    "dataType": "external",
                    "linkText": "Functions"
                    }, {
                    "repoName": "px-helpers-design",
                    "dataType": "external",
                    "linkText": "Helpers"
                    }, {
                    "repoName": "px-iconography-design",
                    "dataType": "external",
                    "linkText": "iconography"
                    }, {
                    "repoName": "px-mixins-design",
                    "dataType": "external",
                    "linkText": "mixins"
                    }, {
                    "repoName": "px-normalize-design",
                    "dataType": "external",
                    "linkText": "Normalize"
                    }, {
                    "repoName": "px-typography-design",
                    "dataType": "external",
                    "linkText": "Typography"
                    }, {
                    "repoName": "px-viewport-design",
                    "dataType": "external",
                    "linkText": "Viewport"
                  }]
                }
              ]
            },
            {
            "linkText": "Predix UI Components",
            "links": [{
                "repoName": "px-alert-label",
                "dataType": "component",
                "linkText": "Alert Label"
                }, {
                "repoName": "px-alert-message",
                "dataType": "component",
                "linkText": "Alert Message"
                }, {
                "repoName": "px-app-nav",
                "dataType": "component",
                "linkText": "App Nav"
                }, {
                "linkText": "Cards",
                "links": [{
                    "repoName": "px-card",
                    "dataType": "component",
                    "linkText": "Card"
                    }, {
                    "repoName": "px-deck-selector",
                    "dataType": "component",
                    "linkText": "Deck Selector"
                    }, {
                    "repoName": "px-sample-cards",
                    "dataType": "component",
                    "linkText": "Sample Cards"
                    }, {
                    "repoName": "px-widget-cards",
                    "dataType": "component",
                    "linkText": "Widget Cards"
                }]
            }, {
                "linkText": "Charts",
                "links": [
                  {
                    "repoName": "px-percent-circle",
                    "dataType": "component",
                    "linkText": "Percent Circle"
                    }, {
                    "repoName": "px-simple-bar-chart",
                    "dataType": "component",
                    "linkText": "Simple Bar Chart"
                    }, {
                    "repoName": "px-simple-horizontal-bar-chart",
                    "dataType": "component",
                    "linkText": "Simple horizontal Bar Chart"
                    }, {
                    "repoName": "px-simple-line-chart",
                    "dataType": "component",
                    "linkText": "Simple Line Chart"
                    }, {
                    "repoName": "px-chart",
                    "dataType": "component",
                    "linkText": "Chart"
                    }, {
                    "repoName": "px-vis",
                    "dataType": "component",
                    "linkText": "Vis Framwork"
                    }, {
                    "repoName": "px-vis-pie-chart",
                    "dataType": "component",
                    "linkText": "Vis Pie Chart"
                    }, {
                    "repoName": "px-vis-timeseries",
                    "dataType": "component",
                    "linkText": "Vis Timeseries"
                    }, {
                    "repoName": "px-vis-xy-chart",
                    "dataType": "component",
                    "linkText": "Vis XY Chart"
                }]

                }, {
                "repoName": "px-clipboard",
                "dataType": "component",
                "linkText": "Clipboard"
                }, {
                "repoName": "px-context-browser",
                "dataType": "component",
                "linkText": "Context Browser"
                }, {
                "repoName": "px-data-table",
                "dataType": "component",
                "linkText": "Data Table"
                }, {
                "linkText": "Datetime Components",
                "links": [{
                    "repoName": "px-calendar-picker",
                    "dataType": "component",
                    "linkText": "Calendar Picker"
                    }, {
                    "repoName": "px-datetime-field",
                    "dataType": "component",
                    "linkText": "Datetime Field"
                    }, {
                    "repoName": "px-datetime-picker",
                    "dataType": "component",
                    "linkText": "Datetime Picker"
                    }, {
                    "repoName": "px-datetime-range-field",
                    "dataType": "component",
                    "linkText": "DateTime Range Field"
                    }, {
                    "repoName": "px-datetime-range-panel",
                    "dataType": "component",
                    "linkText": "Datetime range Panel"
                    }, {
                    "repoName": "px-rangepicker",
                    "dataType": "component",
                    "linkText": "Rangepicker"
                }]
                }, {
                "repoName": "px-dropdown",
                "dataType": "component",
                "linkText": "Dropdown"
                }, {
                "repoName": "px-file-upload",
                "dataType": "component",
                "linkText": "File Upload"
                }, {
                "repoName": "polymer-font-awesome",
                "dataType": "component",
                "linkText": "Font Awesome"
                }, {
                "repoName": "px-login",
                "dataType": "component",
                "linkText": "Login"
                }, {
                "repoName": "px-modal",
                "dataType": "component",
                "linkText": "Modal"
                }, {
                "repoName": "px-overlay",
                "dataType": "component",
                "linkText": "Overlay"
                }, {
                "repoName": "px-popover",
                "dataType": "component",
                "linkText": "Popover"
                }, {
                "repoName": "px-progress-bar",
                "dataType": "component",
                "linkText": "Progress Bar"
                }, {
                "repoName": "px-slider",
                "dataType": "component",
                "linkText": "Slider"
                }, {
                "repoName": "px-spinner",
                "dataType": "component",
                "linkText": "Spinner"
                }, {
                "repoName": "px-tabs",
                "dataType": "component",
                "linkText": "Tabs"
                }, {
                "repoName": "px-tooltip",
                "dataType": "component",
                "linkText": "Tooltip"
                }, {
                "repoName": "px-validation",
                "dataType": "component",
                "linkText": "Validation"
            }]
        }]
      }
    }
  });
</script>
